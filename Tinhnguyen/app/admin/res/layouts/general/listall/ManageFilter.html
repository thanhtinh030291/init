<div class="modal fade" id="manage-filter-modal" role="dialog"
     aria-labelledby="ManageFilterModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="ManageFilterModalLabel">
                    {$res->i18n->manageFilter}
                </h4>
            </div>
            <div class="modal-body">
                <div class="row" style="padding: 20px 20px 20px 20px">
                    {foreach $filters as $filter}
                        <form method="post" show="loading">
                            <input type="hidden" name="{$tokenName}_token" value="{$tokenValue}" />
                            <div class="col-lg-8">
                                <input type="hidden" name="filter_item" value="{$filter['id']}" />
                                <p class="form-control-static">
                                    <i class="fa fa-filter"></i> {$filter['name']}
                                </p>
                            </div>
                            <div class="col-lg-4">
                                <p class="form-control-static">
                                    <a class="btn btn-outline bth-link"
                                       data-toggle="modal"
                                       data-target="#edit-filter-modal-{$filter['id']}">
                                        <i class="fa fa-edit"></i>
                                        {$res->i18n->edit}
                                    </a>
                                    <button type="submit"
                                            class="btn btn-outline bth-link"
                                            name="action"
                                            value="DeleteFilter">
                                        <i class="fa fa-remove"></i>
                                        {$res->i18n->delete}
                                    </button>
                                </p>
                            </div>
                        </form>
                    {/foreach}
                </div>
            </div>
        </div>
    </div>
</div>
{foreach $filters as $filter}
    <form method="post" id="edit-filter-form-{$filter['id']}" show="loading">
        <input type="hidden" name="{$tokenName}_token" value="{$tokenValue}" />
        <div class="modal fade" id="edit-filter-modal-{$filter['id']}" role="dialog"
             aria-labelledby="EditFilterModalLabel{$filter['id']}"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="EditFilterModalLabel{$filter['id']}">
                            {$res->i18n->editFilter}
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="row" style="padding: 20px 20px 20px 20px">
                            <input type="hidden" name="edit_filter_id" value="{$filter['id']}">
                            <span><b>{$res->i18n->name}</b></span>
                            <div class="form-group input-group">
                                <input type="text" class="form-control required"
                                       id="edit-filter-name-{$filter['id']}"
                                       name="edit_filter_name"
                                       value="{$filter['name']}" />
                                <span class="input-group-addon">
                                    <i class="fa fa-font"></i>
                                </span>
                            </div>
                            <span><b>{$res->i18n->columns}</b></span>
                            <div class="form-group input-group">
                                <select multiple="multiple"
                                        class="form-control required"
                                        id="edit-filter-columns-{$filter['id']}"
                                        name="edit_filter_columns[]">
                                    {foreach $allFields as $field}
                                        {if !in_array($field['type'], ['have', 'has'])}
                                            <option value="{$field['id']}"
                                                {if in_array(
                                                    $field['id'],
                                                    $res->encryptor->jsonDecode($filter['selections'], true))}
                                                    selected="selected"
                                                {/if}>
                                                {$field["single`$smarty.session.lzalanguage`"]}
                                            </option>
                                        {/if}
                                    {/foreach}
                                </select>
                                <script type="text/javascript">
                                $(document).ready(function()
                                {
                                    $("#edit-filter-columns-{$filter['id']}").select2(
                                    {
                                        containerCssClass: ":all"
                                    });
                                    $("#edit-filter-columns-{$filter['id']}").on(
                                        "select2:select",
                                        function (e)
                                        {
                                            var element = e.params.data.element;
                                            var $element = $(element);

                                            $element.detach();
                                            $(this).append($element);
                                            $(this).trigger("change");
                                        }
                                    );
                                });
                                </script>
                                <span class="input-group-addon">
                                    <i class="fa fa-font"></i>
                                </span>
                            </div>
                            <span><b>{$res->i18n->conditions}</b></span>
                            <span><b>{$res->i18n->conditions}</b></span>
                            <div class="form-group input-group hide">
                                <input type="text" class="form-control"
                                       id="edit-filter-conditions-{$filter['id']}"
                                       name="edit_filter_conditions"
                                       value="{$filter['conditions']}" />
                                <span class="input-group-addon">
                                    <i class="fa fa-font"></i>
                                </span>
                            </div>
                            <div id="edit-filter-conditions-builder-{$filter['id']}"></div>
                            <script type="text/javascript">
                            $('#edit-filter-conditions-builder-{$filter['id']}').queryBuilder(
                            {
                                sortable: true,
                                filters:
                                [
                                    {foreach $allFields as $field}
                                        {if in_array($field['type'], ['text', 'link', 'email', 'phone'])}
                                        {
                                            id: '{"`$table['id']`.`$field['field']`"}',
                                            label: '{$field["single`$smarty.session.lzalanguage`"]}',
                                            type: 'string',
                                            operators:
                                                [
                                                    'equal',
                                                    'not_equal',
                                                    'less',
                                                    'less_or_equal',
                                                    'greater',
                                                    'greater_or_equal',
                                                    'between',
                                                    'not_between',
                                                    'begins_with',
                                                    'not_begins_with',
                                                    'contains',
                                                    'not_contains',
                                                    'ends_with',
                                                    'not_ends_with',
                                                    'is_empty',
                                                    'is_not_empty',
                                                    'is_null',
                                                    'is_not_null'
                                                ],
                                            input: 'text'
                                        },
                                        {elseif in_array($field['type'], ['textarea', 'html'])}
                                        {
                                            id: '{"`$table['id']`.`$field['field']`"}',
                                            label: '{$field["single`$smarty.session.lzalanguage`"]}',
                                            type: 'string',
                                            operators:
                                                [
                                                    'equal',
                                                    'not_equal',
                                                    'less',
                                                    'less_or_equal',
                                                    'greater',
                                                    'greater_or_equal',
                                                    'between',
                                                    'not_between',
                                                    'begins_with',
                                                    'not_begins_with',
                                                    'contains',
                                                    'not_contains',
                                                    'ends_with',
                                                    'not_ends_with',
                                                    'is_empty',
                                                    'is_not_empty',
                                                    'is_null',
                                                    'is_not_null'
                                                ],
                                            input: 'textarea'
                                        },
                                        {elseif in_array($field['type'], ['integer'])}
                                        {
                                            id: '{"`$table['id']`.`$field['field']`"}',
                                            label: '{$field["single`$smarty.session.lzalanguage`"]}',
                                            type: 'integer',
                                            operators:
                                            [
                                                'equal',
                                                'not_equal',
                                                'less',
                                                'less_or_equal',
                                                'greater',
                                                'greater_or_equal',
                                                'between',
                                                'not_between',
                                                'begins_with',
                                                'not_begins_with',
                                                'contains',
                                                'not_contains',
                                                'ends_with',
                                                'not_ends_with',
                                                'is_empty',
                                                'is_not_empty',
                                                'is_null',
                                                'is_not_null'
                                            ],
                                            input: 'number'
                                        },
                                        {elseif in_array($field['type'], ['float','double'])}
                                        {
                                            id: '{"`$table['id']`.`$field['field']`"}',
                                            label: '{$field["single`$smarty.session.lzalanguage`"]}',
                                            type: 'double',
                                            operators:
                                                [
                                                    'equal',
                                                    'not_equal',
                                                    'less',
                                                    'less_or_equal',
                                                    'greater',
                                                    'greater_or_equal',
                                                    'between',
                                                    'not_between',
                                                    'begins_with',
                                                    'not_begins_with',
                                                    'contains',
                                                    'not_contains',
                                                    'ends_with',
                                                    'not_ends_with',
                                                    'is_empty',
                                                    'is_not_empty',
                                                    'is_null',
                                                    'is_not_null'
                                                ],
                                            input: 'number'
                                        },
                                        {elseif in_array($field['type'], ['date'])}
                                        {
                                            id: '{"`$table['id']`.`$field['field']`"}',
                                            label: '{$field["single`$smarty.session.lzalanguage`"]}',
                                            type: 'date',
                                            operators:
                                                [
                                                    'equal',
                                                    'not_equal',
                                                    'less',
                                                    'less_or_equal',
                                                    'greater',
                                                    'greater_or_equal',
                                                    'between',
                                                    'not_between',
                                                    'is_null',
                                                    'is_not_null'
                                                ],
                                            input: 'text',
                                            plugin: 'datetimepicker',
                                            plugin_config: {
                                                format: '{DATE_FORMAT}',
                                                timepicker: false
                                            }
                                        },
                                        {elseif in_array(
                                            $field['type'],
                                            ['datetime','eventstart','eventend']
                                         )}
                                        {
                                            id: '{"`$table['id']`.`$field['field']`"}',
                                            label: '{$field["single`$smarty.session.lzalanguage`"]}',
                                            type: 'datetime',
                                            operators:
                                                [
                                                    'equal',
                                                    'not_equal',
                                                    'less',
                                                    'less_or_equal',
                                                    'greater',
                                                    'greater_or_equal',
                                                    'between',
                                                    'not_between',
                                                    'is_null',
                                                    'is_not_null'
                                                ],
                                            input: 'text',
                                            plugin: 'datetimepicker',
                                            plugin_config: {
                                                format: '{DATETIME_FORMAT}',
                                                timepicker: true
                                            }
                                        },
                                        {elseif in_array($field['type'], ['checkbox'])}
                                        {
                                            id: '{"`$table['id']`.`$field['field']`"}',
                                            label: '{$field["single`$smarty.session.lzalanguage`"]}',
                                            type: 'integer',
                                            operators: ['equal'],
                                            input: 'radio',
                                            values: { 1 : 'Yes', 2: 'No' }
                                        },
                                        {elseif in_array($field['type'], ['enum'])}
                                        {
                                            id: '{"`$table['id']`.`$field['field']`"}',
                                            label: '{$field["single`$smarty.session.lzalanguage`"]}',
                                            type: 'string',
                                            operators:
                                                [
                                                    'equal',
                                                    'not_equal',
                                                    'is_null',
                                                    'is_not_null'
                                                ],
                                            input: 'select',
                                            values: {$field['display']}
                                        },
                                        {elseif in_array($field['type'], ['belong'])}
                                            {assign var=refTable value=$field['field']}
                                            {assign var=refFields
                                                    value=$database->lzafield(
                                                        'lzamodule.id = ?',
                                                        $refTable
                                                    )}
                                            {foreach $refFields as $refField}
                                                {if in_array(
                                                    $refField['type'],
                                                    ['text', 'link', 'email', 'phone']
                                                 )}
                                                {
                                                    id: '{"`$refTable`.`$refField['field']`"}',
                                                    label: '{"`$field["single`$smarty.session.lzalanguage`"]` `$refField["single`$smarty.session.lzalanguage`"]`"}',
                                                    type: 'string',
                                                    operators:
                                                        [
                                                            'equal',
                                                            'not_equal',
                                                            'less',
                                                            'less_or_equal',
                                                            'greater',
                                                            'greater_or_equal',
                                                            'between',
                                                            'not_between',
                                                            'begins_with',
                                                            'not_begins_with',
                                                            'contains',
                                                            'not_contains',
                                                            'ends_with',
                                                            'not_ends_with',
                                                            'is_empty',
                                                            'is_not_empty',
                                                            'is_null',
                                                            'is_not_null'
                                                        ],
                                                    input: 'text'
                                                },
                                                {elseif in_array($refField['type'], ['textarea', 'html'])}
                                                {
                                                    id: '{"`$refTable`.`$refField['field']`"}',
                                                    label: '{"`$field["single`$smarty.session.lzalanguage`"]` `$refField["single`$smarty.session.lzalanguage`"]`"}',
                                                    type: 'string',
                                                    operators:
                                                        [
                                                            'equal',
                                                            'not_equal',
                                                            'less',
                                                            'less_or_equal',
                                                            'greater',
                                                            'greater_or_equal',
                                                            'between',
                                                            'not_between',
                                                            'begins_with',
                                                            'not_begins_with',
                                                            'contains',
                                                            'not_contains',
                                                            'ends_with',
                                                            'not_ends_with',
                                                            'is_empty',
                                                            'is_not_empty',
                                                            'is_null',
                                                            'is_not_null'
                                                        ],
                                                    input: 'textarea'
                                                },
                                                {elseif in_array($refField['type'], ['integer'])}
                                                {
                                                    id: '{"`$refTable`.`$refField['field']`"}',
                                                    label: '{"`$field["single`$smarty.session.lzalanguage`"]` `$refField["single`$smarty.session.lzalanguage`"]`"}',
                                                    type: 'integer',
                                                    operators:
                                                    [
                                                        'equal',
                                                        'not_equal',
                                                        'less',
                                                        'less_or_equal',
                                                        'greater',
                                                        'greater_or_equal',
                                                        'between',
                                                        'not_between',
                                                        'begins_with',
                                                        'not_begins_with',
                                                        'contains',
                                                        'not_contains',
                                                        'ends_with',
                                                        'not_ends_with',
                                                        'is_empty',
                                                        'is_not_empty',
                                                        'is_null',
                                                        'is_not_null'
                                                    ],
                                                    input: 'number'
                                                },
                                                {elseif in_array($refField['type'], ['float','double'])}
                                                {
                                                    id: '{"`$refTable`.`$refField['field']`"}',
                                                    label: '{"`$field["single`$smarty.session.lzalanguage`"]` `$refField["single`$smarty.session.lzalanguage`"]`"}',
                                                    type: 'double',
                                                    operators:
                                                        [
                                                            'equal',
                                                            'not_equal',
                                                            'less',
                                                            'less_or_equal',
                                                            'greater',
                                                            'greater_or_equal',
                                                            'between',
                                                            'not_between',
                                                            'begins_with',
                                                            'not_begins_with',
                                                            'contains',
                                                            'not_contains',
                                                            'ends_with',
                                                            'not_ends_with',
                                                            'is_empty',
                                                            'is_not_empty',
                                                            'is_null',
                                                            'is_not_null'
                                                        ],
                                                    input: 'number'
                                                },
                                                {elseif in_array($refField['type'], ['date'])}
                                                {
                                                    id: '{"`$refTable`.`$refField['field']`"}',
                                                    label: '{"`$field["single`$smarty.session.lzalanguage`"]` `$refField["single`$smarty.session.lzalanguage`"]`"}',
                                                    type: 'date',
                                                    operators:
                                                        [
                                                            'equal',
                                                            'not_equal',
                                                            'less',
                                                            'less_or_equal',
                                                            'greater',
                                                            'greater_or_equal',
                                                            'between',
                                                            'not_between',
                                                            'is_null',
                                                            'is_not_null'
                                                        ],
                                                    input: 'text'
                                                },
                                                {elseif in_array(
                                                    $refField['type'],
                                                    ['datetime','eventstart','eventend']
                                                 )}
                                                {
                                                    id: '{"`$refTable`.`$refField['field']`"}',
                                                    label: '{"`$field["single`$smarty.session.lzalanguage`"]` `$refField["single`$smarty.session.lzalanguage`"]`"}',
                                                    type: 'datetime',
                                                    operators:
                                                        [
                                                            'equal',
                                                            'not_equal',
                                                            'less',
                                                            'less_or_equal',
                                                            'greater',
                                                            'greater_or_equal',
                                                            'between',
                                                            'not_between',
                                                            'is_null',
                                                            'is_not_null'
                                                        ],
                                                    input: 'text'
                                                },
                                                {elseif in_array($refField['type'], ['checkbox'])}
                                                {
                                                    id: '{"`$refTable`.`$refField['field']`"}',
                                                    label: '{"`$field["single`$smarty.session.lzalanguage`"]` `$refField["single`$smarty.session.lzalanguage`"]`"}',
                                                    type: 'integer',
                                                    operators: ['equal'],
                                                    input: 'radio',
                                                    values: { 1 : 'Yes', 2: 'No' }
                                                },
                                                {elseif in_array($refField['type'], ['enum'])}
                                                {
                                                    id: '{"`$refTable`.`$refField['field']`"}',
                                                    label: '{"`$field["single`$smarty.session.lzalanguage`"]` `$refField["single`$smarty.session.lzalanguage`"]`"}',
                                                    type: 'string',
                                                    operators:
                                                        [
                                                            'equal',
                                                            'not_equal',
                                                            'is_null',
                                                            'is_not_null'
                                                        ],
                                                    input: 'select',
                                                    values: {$refField['display']}
                                                },
                                                {/if}
                                            {/foreach}
                                        {/if}
                                    {/foreach}
                                ]
                            });
                            </script>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" name="action" value="UpdateFilter" class="btn btn-warning">
                            {$res->i18n->update}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <script type="text/javascript">
    $('#edit-filter-form-{$filter['id']}').validate(
    {
        errorElement: "em",
        errorPlacement: function(error, element)
        {
            error.addClass( "help-block" );
            element.parents( ".form-group" ).addClass( "has-feedback" );
            if ( element.prop( "type" ) === "checkbox" )
            {
                error.insertAfter( element.parent( "label" ) );
            }
            else
            {
                error.insertAfter( element );
            }
        },
        highlight: function ( element, errorClass, validClass )
        {
            $( element ).parents( ".form-group" ).addClass( "has-error" ).removeClass( "has-success" );
        },
        unhighlight: function ( element, errorClass, validClass )
        {
            $( element ).parents( ".form-group" ).addClass( "has-success" ).removeClass( "has-error" );
        }
    });
    {if strlen($filter['conditions']) > 0 && $filter['conditions'] !== 'true'}
        $('#edit-filter-conditions-builder-{$filter['id']}').queryBuilder(
            'setRulesFromSQL',
            "{$filter['conditions']}"
        );
    {/if}
    $('#edit-filter-form-{$filter['id']}').submit(function()
    {
        $('#edit-filter-conditions-{$filter['id']}').val('true');
        var condition = $('#edit-filter-conditions-builder-{$filter['id']}').queryBuilder('getSQL');
        if (condition.sql.length)
        {
            $('#edit-filter-conditions-{$filter['id']}').val(condition.sql);
        }
    });
    </script>
{/foreach}
